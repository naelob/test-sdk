"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.UrlReplaceHandler = void 0;
const api_1 = require("@opentelemetry/api");
const observabilityOptions_1 = require("../observabilityOptions");
const urlReplaceHandlerOptions_1 = require("./options/urlReplaceHandlerOptions");
/**
 * Replaces url placeholders with values from the request option.
 */
class UrlReplaceHandler {
    /**
     * @public
     * @constructor
     * Creates a new instance of the UrlReplaceHandler class
     * @param {UrlReplaceHandlerOptions} handlerOptions The options for the url replace handler.
     * @returns An instance of the UrlReplaceHandler class
     */
    constructor(handlerOptions = new urlReplaceHandlerOptions_1.UrlReplaceHandlerOptions()) {
        this.handlerOptions = handlerOptions;
        if (!handlerOptions) {
            throw new Error("handlerOptions cannot be undefined");
        }
    }
    /**
     * @inheritdoc
     */
    execute(url, requestInit, requestOptions) {
        let currentOptions = this.handlerOptions;
        if (requestOptions && requestOptions[urlReplaceHandlerOptions_1.UrlReplaceHandlerOptionsKey]) {
            currentOptions = requestOptions[urlReplaceHandlerOptions_1.UrlReplaceHandlerOptionsKey];
        }
        const obsOptions = (0, observabilityOptions_1.getObservabilityOptionsFromRequest)(requestOptions);
        if (obsOptions) {
            return api_1.trace.getTracer(obsOptions.getTracerInstrumentationName()).startActiveSpan("urlReplaceHandler - execute", (span) => {
                try {
                    span.setAttribute("com.microsoft.kiota.handler.urlReplace.enable", currentOptions.enabled);
                    return this.replaceTokensInUrl(currentOptions, url, requestInit, requestOptions);
                }
                finally {
                    span.end();
                }
            });
        }
        return this.replaceTokensInUrl(currentOptions, url, requestInit, requestOptions);
    }
    replaceTokensInUrl(options, url, requestInit, requestOptions) {
        var _a;
        if (options.enabled) {
            Object.keys(options.urlReplacements).forEach((replacementKey) => {
                url = url.replace(replacementKey, options.urlReplacements[replacementKey]);
            });
        }
        const response = (_a = this.next) === null || _a === void 0 ? void 0 : _a.execute(url, requestInit, requestOptions);
        if (!response) {
            throw new Error("Response is undefined");
        }
        return response;
    }
}
exports.UrlReplaceHandler = UrlReplaceHandler;
